name: Laravel Deploy

on:
  push:
    branches: [ "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /var/www
            git pull origin develop
            
            # Clean up old Docker images and containers to save space
            echo "ðŸ§¹ Cleaning up old Docker resources..."
            docker system prune -af --volumes --filter "until=24h" || true
            
            # Build and start containers (using production compose)
            echo "ðŸ”¨ Building Docker containers..."
            docker-compose -f docker-compose.prod.yml build --no-cache --pull
            
            echo "ðŸš€ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # Wait for services
            sleep 10
            
            # Run migrations
            echo "ðŸ“Š Running migrations..."
            docker-compose -f docker-compose.prod.yml exec -T app php artisan migrate --force || true
            
            # Optimize Laravel
            echo "âš¡ Optimizing Laravel..."
            docker-compose -f docker-compose.prod.yml exec -T app php artisan config:cache
            docker-compose -f docker-compose.prod.yml exec -T app php artisan route:cache
            docker-compose -f docker-compose.prod.yml exec -T app php artisan view:cache
            
            # Clean up unused images
            echo "ðŸ§¹ Final cleanup..."
            docker image prune -af --filter "until=48h" || true
            
            # Show disk usage
            echo "ðŸ’¾ Disk usage:"
            df -h
            docker system df