name: Deploy Foodshop API
on:
  push:
    branches: [ "develop" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check environment
        run: |
          whoami
          pwd
          docker --version

      - name: Deploy
        run: |
          cd /var/www/html
          
          git pull origin develop
            
          # Clean up old Docker images and containers to save space
          docker system prune -af
          
          # Build and start containers (using dev compose)
          docker compose -f docker-compose.dev.yml build --no-cache --pull
          
          docker compose -f docker-compose.dev.yml up -d
          
          # Wait for services
          sleep 15
          
          # Install/update dependencies (if needed)
          echo "ðŸ“¦ Installing dependencies..."
          docker compose -f docker-compose.dev.yml exec -T app composer install --no-interaction --optimize-autoloader || true
          
          # Run migrations
          echo "ðŸ“Š Running migrations..."
          docker compose -f docker-compose.dev.yml exec -T app php artisan migrate --force || true
          
          # Optimize Laravel
          docker compose -f docker-compose.dev.yml exec -T app php artisan config:cache
          docker compose -f docker-compose.dev.yml exec -T app php artisan route:cache
          docker compose -f docker-compose.dev.yml exec -T app php artisan view:cache
          
          # Clean up unused images
          docker image prune -af --filter "until=48h" || true
          
          # Show disk usage
          docker system df
